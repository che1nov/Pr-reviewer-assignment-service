# PR Reviewer Assignment Service

Сервис для автоматического назначения ревьюверов на Pull Request'ы.

## Описание

Микросервис назначает ревьюверов на PR и позволяет управлять командами. Основные функции:

- Автоназначение ревьюверов - при создании PR автоматически назначается до 2 активных ревьюверов из команды автора
- Управление командами - создание команд и добавление участников
- Управление пользователями - активация/деактивация участников
- Переназначение - замена ревьювера на другого из его команды
- Merge PR - идемпотентная операция, после которой нельзя менять ревьюверов
- Статистика - количество назначений по пользователям и PR
- Массовая деактивация - деактивация всей команды с переназначением открытых PR

## Стек
- Go 1.24
- PostgreSQL 17
- Роутер: Chi v5
- Миграции: golang-migrate
- Тестирование: standard library testing, k6 для нагрузочных
- Линтер: golangci-lint
- Контейнеризация: Docker + Docker Compose

## Запуск

## Команды
```bash
make help           # Все доступные команды
make build          # Собрать бинарник
make test           # Запустить тесты
make lint           # Проверка кода линтером
make docker-up      # Поднять сервис
make docker-down    # Остановить сервис
make docker-logs    # Посмотреть логи
make load-test      # Нагрузочное тестирование
make clean          # Очистить артефакты
```
### Через Docker

```bash
make docker-up 
```

Сервис поднимется на http://localhost:8080

Проверка:
```bash
curl http://localhost:8080/health
# {"status":"ok"}
```

### Локально
Требуется PostgreSQL:
```bash
export DATABASE_URL="postgres://app:app@localhost:5432/pr_service?sslmode=disable"
export ADMIN_TOKEN="admin-secret"
export USER_TOKEN="user-secret"
make build
make run
```
### Тестирование API

Есть скрипт `test_api.sh` для тестирования всех сценариев работы API:
```bash
chmod +x test_api.sh
./test_api.sh
```

Скрипт проверяет:
- Создание команды
- Создание PR с автоназначением ревьюверов
- Получение PR для ревьювера
- Переназначение ревьювера
- Merge PR
- Статистику
- Массовую деактивацию


## Документация API
Swagger UI доступен после запуска сервиса:
- http://localhost:8080/swagger
Там можно посмотреть все эндпоинты и протестировать.

## Что реализовано

### Основное задание

Все эндпоинты из OpenAPI спецификации:
- `POST /team/add` - создание команды с пользователями
- `GET /team/get` - получение информации о команде
- `POST /users/setIsActive` - установка флага активности
- `POST /pullRequest/create` - создание PR с автоназначением ревьюверов
- `POST /pullRequest/merge` - идемпотентный merge
- `POST /pullRequest/reassign` - переназначение ревьювера
- `GET /users/getReview` - список PR пользователя
- `GET /health` - проверка работы сервиса

Бизнес-логика:
- При создании PR назначается до 2 активных ревьюверов из команды автора (сам автор исключается)
- Переназначение берет кандидата из команды заменяемого ревьювера
- После MERGED менять ревьюверов нельзя
- Merge идемпотентен - повторный вызов не вызывает ошибку
- Неактивные пользователи не назначаются на ревью

Инфраструктура:
- PostgreSQL база данных
- Миграции применяются автоматически
- Docker Compose конфигурация

### Дополнительные задания
 Эндпоинт статистики - `GET /stats`
- Показывает количество назначений по пользователям
- Общая статистика по PR (всего, открытых, merged)
- Количество уникальных ревьюверов

 Нагрузочное тестирование
- Провел тестирование с помощью k6
- Все SLI выполнены с запасом (подробности в `LOAD_TEST_RESULTS.md`):
  - RPS: 13.07 (требовалось ≥5)
  - P95 латентность: 39ms (требовалось <300ms)
  - Успешность: 100% (требовалось ≥99.9%)

 Массовая деактивация - `POST /team/deactivateUsers`
- Деактивирует всех пользователей команды
- Переназначает их открытые PR на других активных
- Укладывается в 34ms (требование <100ms)

 Integration тесты
- 4 E2E теста с реальной PostgreSQL
- Проверяют полные сценарии работы через HTTP API

 Конфигурация линтера
- Настроен golangci-lint с 15 линтерами
- Конфигурация в `.golangci.yml`

## Тестирование

Unit тесты:
```bash
make test-unit
```

Integration тесты:
```bash
make test-integration
```

Все тесты:
```bash
make test
```

Нагрузочные тесты:
```bash
make load-test
```

## Технические решения

#### Назначение ревьюверов
При создании PR ищу активных участников команды автора, исключаю самого автора, перемешиваю список и беру первых 2. Если кандидатов меньше - назначаю сколько есть.

#### Переназначение
Ищу кандидатов **в команде заменяемого** ревьювера (не автора). Это значит, что если автор из команды A, а ревьювер из команды B, то новый ревьювер будет из команды B. Если в спецификации указан `desired_new_reviewer_id` - проверяю что он из нужной команды.

#### Массовая деактивация
Деактивирую всех пользователей команды и для каждого их открытого PR пытаюсь найти замену из их же команды. Если замены нет - убираю ревьювера из PR. Merged PR не трогаю.
Операция достаточно быстрая (~34ms), т.к. делаю batch операции с БД где возможно.

#### Идемпотентность merge
При повторном merge просто возвращаю текущее состояние PR без ошибки. Проверяю статус в начале и если уже MERGED - сразу возвращаю.
